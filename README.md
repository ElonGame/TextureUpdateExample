TextureUpdateExample
====================

![gif](https://i.imgur.com/VqHhCcx.gif)

*Old-school plasma effect generated by C++ code*

This is an example that shows how to use the [CustomTextureUpdate] callback
that allows native plugins to update contents of textures in a thread safe and
platform agnostic way.

[CustomTextureUpdate]: https://docs.unity3d.com/ScriptReference/Rendering.CommandBuffer.IssuePluginCustomTextureUpdate.html

How to implement the CustomTextureUpdate callback
-------------------------------------------------

The callback function should be implemented with the following signature:

```
void TextureUpdateCallback(int eventID, void* data) { }
```

The type of the event will be given to `eventID`, and the attributes of the
target texture will be given with `UnityRenderingExtTextureUpdateParams` struct
carried by the `data` pointer (it should be typecast to
`UnityRenderingExtTextureUpdateParams*` in the callback).

The possible values of `eventID` are defined in `UnityRenderingExtEventType`;
Only `kUnityRenderingExtEventUpdateTextureBegin` and
`kUnityRenderingExtEventUpdateTextureEnd` are relevant to the texture update
callback.

### `kUnityRenderingExtEventUpdateTextureBegin` event

This event is invoked right before updating the texture. You can give raw image
data via the `texData` pointer in the parameter struct.

```
uint8_t* img = new uint32_t[params->width * params->height * 4];

// Set image data.

params->texData = img;
```

You can also give `nullptr` to `texData` when you don't like to update the
texture in this callback.

### `kUnityRenderingExtEventUpdateTextureEnd` event

This event is invoked right after updating the texture. You can safely release
resources used to update the texture.

```
delete[] reinterpret_cast<uint32_t*>(params->texData);
```

### Interface function

You have to implement an interface function that is used to retrieve the
pointer of the callback function.

```
extern "C"
UnityRenderingEventAndData UNITY_INTERFACE_EXPORT GetTextureUpdateCallback()
{
    return TextureUpdateCallback;
}
```

For further details of the plugin implementation, please see the [example
source code](https://github.com/keijiro/TextureUpdateExample/blob/master/Plugin/Plasma.cpp)
contained in this repository.

How to update texture from C# script
------------------------------------

In order to request texture update from a C# script, you can use
`IssuePluginCustomTextureUpdate` with a `CommandBuffer`. The pointer to the
callback function and a reference to a texture object should be given to the
command. You can also give a single `uint` value to the command that can be
used as user data to the callback.

```
[DllImport("DllName")] static extern IntPtr GetTextureUpdateCallback();

m_callback = GetTextureUpdateCallback();
m_CommandBuffer.IssuePluginCustomTextureUpdate(m_callback, texture, userData);
Graphics.ExecuteCommandBuffer(m_CommandBuffer);
```

Platform availability
---------------------

At the moment of Unity 2017.2, the CustomTextureUpdate callback is only
available in Direct3D 11, Metal and OpenGL ES. For other platforms (Vulkan,
consoles, etc.), you have to implement the plugin without using this interface.
